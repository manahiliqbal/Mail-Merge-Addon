<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
  <style>
    body {
      color: #ffffff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .container {
      max-width: 600px;
      padding-top: 20px;
      margin: auto;
      box-shadow: 0 10px 20px rgba(45, 29, 29, 0.3), 0 0 15px rgba(22, 84, 150, 0.5);
      padding: 20px;
      color: #000;
    }
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding: 20px 20px;
      border-radius: 8px 8px 0 0;
      width: calc(100% + 40px);
      margin-left: -20px;
      margin-right: -20px;
      margin-top: -20px;
    }
    .header h2 {
      margin: 0;
      display: flex;
      align-items: center;
      color: #0056b3;
    }
    .header .dark-mode-toggle {
      cursor: pointer;
      font-size: 24px;
    }
    .header .how-to-use {
      margin-left: auto;
      margin-right: 0;
      font-size: 14px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .btn-primary {
      width: 100%;
      background-color: #0056b3;
      border-color: #007bff;
      color: white;
    }
    .btn-preview, .btn-save {
      background-color: #0056b3;
      border-color: #007bff;
      margin-bottom: 20px;
      color: white;
    }
    .btn-primary:hover, .btn-preview:hover, .btn-save:hover {
      background-color: #007bff;
      border-color: #0056b3;
      color: white;
    }
    .dark-mode {
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: white;
    }
    .dark-mode .container {
      background-color: rgba(0, 0, 0, 0.8);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 123, 255, 0.5);
      color: white;
    }
    .dark-mode .btn-primary,
    .dark-mode .btn-preview,
    .dark-mode .btn-save {
      background-color: #31a2ff;
      border-color: #007bff;
    }
    .dark-mode label,
    .dark-mode select,
    .dark-mode input,
    .dark-mode option {
      color: white;
    }
    input[type="file"] {
      padding: 3px;
    }
    .help {
      display: flex;
      align-items: flex-end;
      justify-content: end;
      margin-bottom: 10px;
      color: #0056b3;
    }
    .ql-editor {
      min-height: 150px;
    }
    .note {
      color: gray;
      font-size: 0.9em;
      margin-top: -10px;
      margin-bottom: 10px;
    }
    .button-container {
      display: flex;
      gap: 10px;
    }
    .button-container .btn-preview, .button-container .btn-save {
      width: 100%;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Mail Merge</h2>
      <span class="dark-mode-toggle" onclick="toggleDarkMode()">ðŸŒž</span>
    </div>
    <div class="help"><span class="how-to-use"><a href="#" onclick="loadHowToUse()">How to Use Mail Merge</a></span></div>
    
    <form id="mailMergeForm">
      <div class="form-group">
        <label for="senderName">Sender's Name:</label>
        <input type="text" id="senderName" name="senderName" class="form-control">
      </div>
      <div class="form-group">
        <label for="senderEmail">Sender's Email:</label>
        <input type="email" id="senderEmail" name="senderEmail" class="form-control">
      </div>
      <div class="form-group">
        <label for="templateOption">Choose Email Template:</label>
        <select id="templateOption" name="templateOption" class="form-control" onchange="toggleTemplateOption(this.value)">
          <option value="">Select an option</option>
          <option value="prebuilt">Select a Pre-built Template</option>
          <option value="local">Upload a Template from Drive</option>
          <option value="write">Write an Email</option>
        </select>
      </div>
      <div class="form-group" id="prebuiltTemplateSelect" style="display: none;">
        <label for="templateDocument">Select Template Document:</label>
        <select id="templateDocument" name="templateDocument" class="form-control"></select>
      </div>
      <div class="form-group" id="localFileInput" style="display: none;">
        <label for="localTemplateFile">Upload Template File:</label>
        <input type="file" id="localTemplateFile" name="localTemplateFile" class="form-control">
      </div>
      <div class="form-group" id="writeEmailInput" style="display: none;">
        <label for="emailSubject">Email Subject:</label>
        <input type="text" id="emailSubject" name="emailSubject" class="form-control">
        <label for="emailContent">Write Your Email:</label>
        <div class="note">(use {{FirstName}} and {{LastName}} for personalization)</div>
        <div id="editorContainer" style="height: 200px; background-color: white;"></div>
        <button type="button" class="btn btn-save" onclick="saveEmailContent()">Save Email</button>
      </div>
      <div class="form-group">
        <label for="sheetSelect">Select Sheet:</label>
        <select id="sheetSelect" name="sheetSelect" class="form-control"></select>
      </div>
      <div class="form-group">
        <label for="attachmentFile">If you wish to include an attachment file in your email, please upload the file:</label>
       <input type="file" id="attachmentFile" name="attachmentFile" class="form-control" accept="image/*">
      </div>

      <div class="form-group button-container">
        <button type="button" class="btn btn-preview" onclick="previewEmail()">Preview Email</button>
         <a href="#" onclick="loadSchedulePage()" class="btn btn-preview">Schedule Email</a>
      </div>
    </form>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="previewModal" tabindex="-1" role="dialog" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="previewModalLabel">Email Preview</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div style="color:black;" class="modal-body" id="previewContent">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-save" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    var quill;

    document.addEventListener('DOMContentLoaded', function() {
      quill = new Quill('#editorContainer', {
        theme: 'snow',
        modules: {
          toolbar: [
            [{ 'font': [] }, { 'size': [] }],
            ['bold', 'italic', 'underline', 'strike'],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'header': '1' }, { 'header': '2' }, 'blockquote', 'code-block'],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }, { 'indent': '-1' }, { 'indent': '+1' }],
            ['direction', { 'align': [] }],
            ['link', 'video'],
            ['clean']
          ]
        }
      });
      populateTemplates();
      populateSheets();
      loadEmailContent();
    });

    function populateTemplates() {
      google.script.run.withSuccessHandler(function(templates) {
        const templateSelect = document.getElementById('templateDocument');
        templates.forEach(template => {
          const option = document.createElement('option');
          option.value = template.id;
          option.textContent = template.name;
          templateSelect.appendChild(option);
        });
      }).getTemplateList();
    }

    function populateSheets() {
      google.script.run.withSuccessHandler(function(sheets) {
        const sheetSelect = document.getElementById('sheetSelect');
        sheets.forEach(sheet => {
          const option = document.createElement('option');
          option.value = sheet.name;
          option.textContent = sheet.name;
          sheetSelect.appendChild(option);
        });
      }).getSheetList();
    }

    function toggleTemplateOption(value) {
      const prebuiltTemplateSelect = document.getElementById('prebuiltTemplateSelect');
      const localFileInput = document.getElementById('localFileInput');
      const writeEmailInput = document.getElementById('writeEmailInput');
      const saveButton = document.querySelector('.btn-save');
      if (value === 'prebuilt') {
        prebuiltTemplateSelect.style.display = 'block';
        localFileInput.style.display = 'none';
        writeEmailInput.style.display = 'none';
      } else if (value === 'write') {
        prebuiltTemplateSelect.style.display = 'none';
        localFileInput.style.display = 'none';
        writeEmailInput.style.display = 'block';
        saveButton.style.display = 'block';
      } else {
        prebuiltTemplateSelect.style.display = 'none';
        localFileInput.style.display = 'none';
        writeEmailInput.style.display = 'none';
        saveButton.style.display = 'none';
      }
    }




function validateAttachment() {
  const attachmentFile = document.getElementById('attachmentFile').files[0];
  if (attachmentFile && !attachmentFile.type.startsWith('image/')) {
    alert('Only image files are allowed.');
    document.getElementById('attachmentFile').value = ''; // Clear the input
    return false;
  }
  return true;
}

function saveEmailContent() {
  if (!validateAttachment()) {
    return;
  }

  const emailContent = quill.root.innerHTML;
  const emailSubject = document.getElementById('emailSubject').value;
  const attachmentFile = document.getElementById('attachmentFile').files[0];

  if (attachmentFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const attachmentData = e.target.result;
      google.script.run.storeRuntimeEmailContentWithAttachment(emailSubject, emailContent, attachmentData, attachmentFile.name);
      alert('Email content and attachment saved!');
    };
    reader.readAsDataURL(attachmentFile);
  } else {
    google.script.run.storeRuntimeEmailContent(emailSubject, emailContent);
    alert('Email content saved!');
  }
}

function loadEmailContent() {
  google.script.run.withSuccessHandler(function(content) {
    console.log('Loaded email content:', content);
    if (content) {
      quill.root.innerHTML = content.emailContent;
      document.getElementById('emailSubject').value = content.emailSubject;
      if (content.attachment) {
        const attachmentPreview = document.createElement('img');
        attachmentPreview.src = content.attachment.data;
        attachmentPreview.alt = content.attachment.name;
        document.getElementById('previewContent').appendChild(attachmentPreview);
      }
    }
  }).getRuntimeEmailContent();
}

function previewEmail() {
  if (!validateAttachment()) {
    return;
  }

  const selectedOption = document.getElementById('templateOption').value;
  let templateContent = '';
  let emailSubject = '';

  if (selectedOption === 'write') {
    templateContent = quill.root.innerHTML;
    emailSubject = document.getElementById('emailSubject').value || 'No Subject';
    console.log('Template content from write:', templateContent);
    showPreview(templateContent, emailSubject);
  } else if (selectedOption === 'prebuilt') {
    const selectedTemplate = document.getElementById('templateDocument').value;
    console.log('Selected prebuilt template:', selectedTemplate);
    google.script.run.withSuccessHandler(function(template) {
      templateContent = template.content;
      emailSubject = template.subject;
      console.log('Template content from prebuilt:', templateContent);
      showPreview(templateContent, emailSubject);
    }).getTemplateContent(selectedTemplate);
  } else {
    showPreview('No template selected.', 'No Subject');
  }
}

function showPreview(templateContent, emailSubject) {
  const senderName = document.getElementById('senderName').value || 'Your Name';
  const senderEmail = document.getElementById('senderEmail').value || 'your.email@example.com';
  const attachmentFile = document.getElementById('attachmentFile').files[0];

  let previewContent = `
    <strong>From:</strong> ${senderName} &lt;${senderEmail}&gt;<br>
    <strong>Subject:</strong> ${emailSubject}<br><br>
    ${templateContent}<br><br>
  `;

  if (attachmentFile) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const attachmentData = e.target.result;
      previewContent += `<br><br><img src="${attachmentData}" alt="${attachmentFile.name}" style="max-width: 100%;">`;
      document.getElementById('previewContent').innerHTML = previewContent;
      $('#previewModal').modal('show');
    };
    reader.readAsDataURL(attachmentFile);
  } else {
    document.getElementById('previewContent').innerHTML = previewContent;
    $('#previewModal').modal('show');
  }

  console.log('Preview content:', previewContent);
}


    function saveEmailContent() {
      const emailContent = quill.root.innerHTML;
      console.log('Saving email content:', emailContent);
      google.script.run.storeRuntimeEmailContent(document.getElementById('emailSubject').value, emailContent);
      alert('Email content saved!');
    }

    function loadEmailContent() {
      google.script.run.withSuccessHandler(function(content) {
        console.log('Loaded email content:', content);
        if (content) {
          quill.root.innerHTML = content.emailContent;
          document.getElementById('emailSubject').value = content.emailSubject;
        }
      }).getRuntimeEmailContent();
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark-mode');
      const darkModeToggle = document.querySelector('.dark-mode-toggle');
      if (document.body.classList.contains('dark-mode')) {
        darkModeToggle.textContent = 'ðŸŒœ';
      } else {
        darkModeToggle.textContent = 'ðŸŒž';
      }
    }

    function loadHowToUse() {
      google.script.run.withSuccessHandler(function(html) {
        document.open();
        document.write(html);
        document.close();
      }).include('how_to_use');
    }
     function loadSchedulePage() {
      google.script.run.withSuccessHandler(function(html) {
        document.open();
        document.write(html);
        document.close();
      }).include('schedule');
    }
  </script>
</body>
</html>
